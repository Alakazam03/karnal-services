---
// src/pages/blog/[id].astro — Programmatic blog post: JSON-LD Article, internal links, CTA
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { getServiceBySlug } from '../../lib/services';

export async function getStaticPaths() {
  const entries = await getCollection('blog');
  return entries.map((entry) => ({
    params: { id: entry.id },
    props: { entry }
  }));
}

interface Props {
  entry: Awaited<ReturnType<typeof getCollection<'blog'>>>[number];
}
const { entry } = Astro.props;
const { Content } = await render(entry);
const baseUrl = Astro.url.origin;
const canonical = `/blog/${entry.id}`;
const service = entry.data.serviceSlug ? getServiceBySlug(entry.data.serviceSlug) : null;
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  canonical={canonical}
  ogImage={`${baseUrl}/api/og.png?label=${encodeURIComponent(entry.data.title)}`}
>
  <article class="mx-auto max-w-3xl px-4 py-10">
    <header class="mb-8">
      <time class="text-sm text-stone-500" datetime={entry.data.pubDate.toISOString()}>
        {entry.data.pubDate.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
      <h1 class="mt-2 text-3xl font-bold text-stone-900">{entry.data.title}</h1>
    </header>
    <div class="prose prose-stone max-w-none prose-headings:font-semibold prose-a:text-emerald-600 prose-a:no-underline hover:prose-a:underline">
      <Content />
    </div>
    {service && (
      <aside class="mt-10 rounded-xl border border-stone-200 bg-stone-50 p-6">
        <h2 class="text-lg font-semibold text-stone-900">Agla step</h2>
        <p class="mt-1 text-sm text-stone-600">{service.description}</p>
        <a
          href={`/service/${service.slug}`}
          class="mt-4 inline-block rounded-lg bg-emerald-600 px-4 py-2 font-medium text-white no-underline hover:bg-emerald-700"
        >
          {service.calculatorType === 'construction' ? 'Calculator & rates dekho' : `${service.ogLabel} dekho`}
        </a>
      </aside>
    )}
    <p class="mt-8 text-sm text-stone-500">
      <a href="/blog" class="text-emerald-600 no-underline hover:underline">← Saare posts</a>
      <span class="mx-2">·</span>
      <a href="/" class="text-emerald-600 no-underline hover:underline">Home</a>
    </p>
  </article>
</BaseLayout>

<script type="application/ld+json" set:html={JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  datePublished: entry.data.pubDate.toISOString(),
  url: `${baseUrl}${canonical}`,
  author: { '@type': 'Organization', name: 'Karnal Local Services' },
  publisher: { '@type': 'Organization', name: 'Karnal Local Services' }
})} />
