---
// src/components/LeadForm.astro — Lead form that logs to Google Sheets + opens WhatsApp
interface Props {
  serviceLabel: string;
  serviceSlug: string;
}
const { serviceLabel, serviceSlug } = Astro.props;
const webhookUrl = import.meta.env.PUBLIC_SHEETS_WEBHOOK_URL || '';
const whatsappNum = import.meta.env.PUBLIC_WHATSAPP_NUMBER || '919876543210';
---

<div class="rounded-xl border border-stone-200 bg-white p-6 shadow-sm" id="lead-form">
  <h2 class="mb-4 text-lg font-semibold text-stone-900">WhatsApp pe baat karo</h2>
  <p class="mb-4 text-sm text-stone-600">
    Form bharo, WhatsApp khul jayega. Hum personally verify karte hain aur best option dete hain—chahe khud karein ya trusted vendor se connect karein.
  </p>
  <form id="whatsapp-lead-form" class="space-y-4">
    <input type="hidden" name="service" value={serviceLabel} data-service-slug={serviceSlug} />
    <div>
      <label for="lead-name" class="mb-1 block text-sm font-medium text-stone-700">Naam</label>
      <input
        id="lead-name"
        name="name"
        type="text"
        required
        class="w-full rounded-lg border border-stone-300 px-3 py-2 text-stone-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
        placeholder="Aapka naam"
      />
    </div>
    <div>
      <label for="lead-phone" class="mb-1 block text-sm font-medium text-stone-700">Phone</label>
      <input
        id="lead-phone"
        name="phone"
        type="tel"
        required
        class="w-full rounded-lg border border-stone-300 px-3 py-2 text-stone-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
        placeholder="10-digit number"
      />
    </div>
    <div>
      <label for="lead-budget" class="mb-1 block text-sm font-medium text-stone-700">Budget (optional)</label>
      <input
        id="lead-budget"
        name="budget"
        type="text"
        class="w-full rounded-lg border border-stone-300 px-3 py-2 text-stone-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
        placeholder="e.g. ₹2 lakh ya ₹50k-1L"
      />
      <p class="mt-1 text-xs text-stone-500">Project samajhne mein madad karta hai</p>
    </div>
    <div>
      <label for="lead-message" class="mb-1 block text-sm font-medium text-stone-700">Kya chahiye? (optional)</label>
      <textarea
        id="lead-message"
        name="message"
        rows={3}
        class="w-full rounded-lg border border-stone-300 px-3 py-2 text-stone-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
        placeholder="e.g. 1200 sq.ft ka quote chahiye, 3BHK construction"
      />
    </div>
    <button
      type="submit"
      class="w-full rounded-lg bg-emerald-600 px-4 py-3 font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
    >
      WhatsApp pe bhejo
    </button>
  </form>
</div>

<script define:vars={{ serviceLabel, serviceSlug, webhookUrl, whatsappNum }}>
  document.getElementById('whatsapp-lead-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const name = (form.querySelector('[name="name"]') as HTMLInputElement).value.trim();
    const phone = (form.querySelector('[name="phone"]') as HTMLInputElement).value.trim();
    const service = (form.querySelector('[name="service"]') as HTMLInputElement).value.trim();
    const budget = (form.querySelector('[name="budget"]') as HTMLInputElement).value.trim();
    const message = (form.querySelector('[name="message"]') as HTMLTextAreaElement).value.trim();
    
    // Track lead with GA4
    if (window.gtag) {
      window.gtag('event', 'generate_lead', { 
        method: 'whatsapp', 
        service_slug: serviceSlug, 
        service_label: serviceLabel,
        budget: budget || undefined
      });
    }
    
    // Log to Google Sheets (fire and forget, non-blocking)
    if (webhookUrl) {
      fetch(webhookUrl, {
        method: 'POST',
        mode: 'no-cors', // Apps Script doesn't support CORS
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          phone,
          service,
          serviceSlug,
          budget: budget || '',
          message: message || ''
        })
      }).catch(() => {
        // Silently fail - WhatsApp is the primary path
      });
    }
    
    // Build WhatsApp message
    const messageParts = [
      `Hi, I'm ${name}.`,
      `Phone: ${phone}.`,
      `Interested in: ${service}.`
    ];
    
    if (budget) {
      messageParts.push(`Budget: ${budget}.`);
    }
    
    if (message) {
      messageParts.push(message);
    }
    
    const text = encodeURIComponent(messageParts.join(' '));
    window.open('https://wa.me/' + whatsappNum + '?text=' + text, '_blank', 'noopener');
  });
</script>
